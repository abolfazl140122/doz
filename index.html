<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>چت روم صوتی عمومی</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; text-align: center; }
        .container { background-color: #fff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); max-width: 500px; width: 90%; }
        h1 { color: #1a73e8; margin-top: 0; }
        p { line-height: 1.6; }
        .buttons { margin: 20px 0; }
        button { background-color: #1a73e8; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 0 10px; transition: background-color 0.3s, transform 0.2s; }
        button:hover:not(:disabled) { background-color: #1558b8; transform: translateY(-2px); }
        button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
        #hangupBtn { background-color: #d93025; }
        #hangupBtn:hover:not(:disabled) { background-color: #b5281e; }
        #status { margin-top: 20px; font-weight: bold; color: #555; min-height: 24px; }
        #remote-audios video, #remote-audios audio { display: none; }
        .lobby { margin-top: 25px; text-align: right; }
        .lobby h3 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        #user-list { list-style-type: none; padding: 0; }
        #user-list li { background-color: #e8f0fe; color: #1a73e8; padding: 8px 12px; border-radius: 20px; margin-bottom: 8px; display: inline-block; font-weight: 500; }
    </style>
</head>
<body>

    <div class="container">
        <h1>چت روم صوتی عمومی</h1>
        <p>با کلیک روی دکمه "ورود به چت"، به اتاق عمومی متصل شوید. لیست کاربران حاضر در زیر نمایش داده می‌شود.</p>
        
        <div class="buttons">
            <button id="joinBtn">ورود به چت</button>
            <button id="hangupBtn" disabled>خروج</button>
        </div>

        <div id="status">در انتظار اتصال...</div>
        
        <div class="lobby">
            <h3>کاربران حاضر در لابی</h3>
            <ul id="user-list">
                <!-- لیست کاربران اینجا قرار می‌گیرد -->
            </ul>
        </div>
        
        <div id="remote-audios"></div>
    </div>

    <script type="module">
        // 1. راه‌اندازی FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, where, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAk3aehEN_aCT0VHE29sSIi72Htpb7vbAk",
            authDomain: "voic-acfa3.firebaseapp.com",
            projectId: "voic-acfa3",
            storageBucket: "voic-acfa3.firebasestorage.app",
            messagingSenderId: "7797643208",
            appId: "1:7797643208:web:ca69e49eb448a96cf8d2fd",
            measurementId: "G-1VQXZKZ6T9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // 2. متغیرهای سراسری و تنظیمات WEBRTC
        const joinBtn = document.getElementById('joinBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const statusDiv = document.getElementById('status');
        const remoteAudiosContainer = document.getElementById('remote-audios');
        const userList = document.getElementById('user-list');

        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

        let localStream, localId, userDocRef;
        const peerConnections = {};
        let firestoreUnsubscribes = [];

        // 3. منطق اصلی برنامه
        const joinRoom = async () => {
            joinBtn.disabled = true;
            statusDiv.textContent = 'در حال درخواست دسترسی به میکروفون...';

            try {
                // مرحله کلیدی: بلافاصله درخواست دسترسی به میکروفون
                localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                statusDiv.textContent = 'دسترسی موفق! در حال اتصال به اتاق...';
                hangupBtn.disabled = false;
                
                localId = Math.random().toString(36).substring(2, 10); // شناسه کوتاه‌تر و خواناتر
                userDocRef = await addDoc(collection(db, 'users'), { id: localId, name: `کاربر ${localId}` });

                setupUserListener();
                setupSignalListener();

            } catch (error) {
                console.error("خطا در دسترسی به میکروفون: ", error);
                statusDiv.textContent = 'امکان دسترسی به میکروفون وجود ندارد. لطفا مجوز را بدهید و دوباره تلاش کنید.';
                joinBtn.disabled = false;
            }
        };
        
        function setupUserListener() {
            const unsubscribe = onSnapshot(collection(db, 'users'), (snapshot) => {
                // پاک کردن لیست فعلی
                userList.innerHTML = '';
                // بازسازی لیست کاربران
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const userElement = document.createElement('li');
                    userElement.textContent = user.name + (user.id === localId ? ' (شما)' : '');
                    userList.appendChild(userElement);
                });

                // مدیریت اتصال به کاربران جدید
                snapshot.docChanges().forEach(async (change) => {
                    const remoteUser = change.doc.data();
                    if (change.type === 'added' && remoteUser.id !== localId) {
                        createPeerConnection(remoteUser.id, true);
                    }
                    if (change.type === 'removed') {
                        if (peerConnections[remoteUser.id]) {
                            peerConnections[remoteUser.id].close();
                            delete peerConnections[remoteUser.id];
                        }
                    }
                });
            });
            firestoreUnsubscribes.push(unsubscribe);
        }

        function setupSignalListener() {
            const q = query(collection(db, 'signals'), where("to", "==", localId));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added') {
                        const { from, sdp, candidate } = change.doc.data();
                        await deleteDoc(doc(db, 'signals', change.doc.id));

                        if (!peerConnections[from]) {
                            createPeerConnection(from, false);
                        }

                        const pc = peerConnections[from];
                        if (sdp) {
                            await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                            if (pc.remoteDescription.type === 'offer') {
                                const answer = await pc.createAnswer();
                                await pc.setLocalDescription(answer);
                                sendSignal(from, { sdp: pc.localDescription });
                            }
                        } else if (candidate) {
                            await pc.addIceCandidate(new RTCIceCandidate(candidate));
                        }
                    }
                });
            });
            firestoreUnsubscribes.push(unsubscribe);
        }

        function createPeerConnection(remoteId, isInitiator) {
            const pc = new RTCPeerConnection(servers);
            peerConnections[remoteId] = pc;

            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.ontrack = event => {
                let audioEl = document.getElementById(`audio-${remoteId}`);
                if (!audioEl) {
                    audioEl = document.createElement('audio');
                    audioEl.id = `audio-${remoteId}`;
                    audioEl.autoplay = true; // این حالا باید کار کند چون در نتیجه یک کلیک اتفاق افتاده
                    audioEl.playsInline = true;
                    remoteAudiosContainer.appendChild(audioEl);
                }
                audioEl.srcObject = event.streams[0];
            };

            pc.onicecandidate = e => e.candidate && sendSignal(remoteId, { candidate: e.candidate.toJSON() });
            
            if (isInitiator) {
                pc.createOffer().then(o => pc.setLocalDescription(o)).then(() => sendSignal(remoteId, { sdp: pc.localDescription }));
            }
        }

        async function sendSignal(toId, data) {
            await addDoc(collection(db, 'signals'), { to: toId, from: localId, ...data });
        }

        const hangup = async () => {
            Object.values(peerConnections).forEach(pc => pc.close());
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            remoteAudiosContainer.innerHTML = '';
            userList.innerHTML = '';
            firestoreUnsubscribes.forEach(unsub => unsub());
            firestoreUnsubscribes = [];
            if (userDocRef) await deleteDoc(userDocRef);
            
            joinBtn.disabled = false;
            hangupBtn.disabled = true;
            statusDiv.textContent = 'شما از اتاق خارج شدید.';
        };

        joinBtn.onclick = joinRoom;
        hangupBtn.onclick = hangup;
        window.addEventListener('beforeunload', () => localStream && hangup());
    </script>
</body>
</html>

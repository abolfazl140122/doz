<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-time Chat with Firebase</title>
  <style>
    body {
      margin: 0;
      padding-bottom: 3rem;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f0f2f5;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #chat-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    #messages {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }
    #messages > li {
      background: #e4e6eb;
      padding: 0.75rem 1rem;
      border-radius: 18px;
      margin-bottom: 0.5rem;
      max-width: 80%;
      word-wrap: break-word;
    }
    #messages > li.mine {
      background: #007bff;
      color: white;
      margin-left: auto;
    }
    .message-info {
      font-size: 0.75em;
      color: #65676b;
      margin-top: 0.2rem;
      display: block;
    }
    li.mine .message-info {
      color: #d1e2ff;
    }
    #form-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 0.5rem;
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    #user-input {
      border: 1px solid #ccc;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      margin-right: 0.5rem;
    }
    #user-input:focus { outline: none; border-color: #007bff; }

    #form {
      display: flex;
      flex-grow: 1;
    }
    #message-input {
      border: 1px solid #ccc;
      padding: 0.5rem 1rem;
      flex-grow: 1;
      border-radius: 20px;
      margin-right: 0.5rem;
    }
    #message-input:focus { outline: none; border-color: #007bff; }
    #form > button {
      background: #007bff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      outline: none;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
    }
    #form > button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <ul id="messages"></ul>
  </div>

  <div id="form-container">
    <input type="text" id="user-input" placeholder="Your Name" value="Anonymous" />
    <form id="form" action="">
      <input id="message-input" autocomplete="off" placeholder="Type your message..." />
      <button>Send</button>
    </form>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    // For analytics, if you uncomment, also uncomment the call in initializeApp
    // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAk3aehEN_aCT0VHE29sSIi72Htpb7vbAk",
      authDomain: "voic-acfa3.firebaseapp.com",
      projectId: "voic-acfa3",
      storageBucket: "voic-acfa3.firebasestorage.app",
      messagingSenderId: "7797643208",
      appId: "1:7797643208:web:ca69e49eb448a96cf8d2fd",
      measurementId: "G-1VQXZKZ6T9"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    // const analytics = getAnalytics(app); // Uncomment if you use analytics
    const db = getFirestore(app); // Get Firestore instance

    const form = document.getElementById('form');
    const messageInput = document.getElementById('message-input');
    const userInput = document.getElementById('user-input');
    const messagesUl = document.getElementById('messages');

    // Reference to the 'messages' collection in Firestore
    const messagesCollection = collection(db, 'messages');

    // Create a query to order messages by timestamp and listen for real-time updates
    const q = query(messagesCollection, orderBy('timestamp'));

    // Set up real-time listener for messages
    onSnapshot(q, (snapshot) => {
      // Clear existing messages to re-render fresh list (simpler for this example)
      // For more complex apps, you'd update specific DOM elements
      messagesUl.innerHTML = '';
      snapshot.forEach((doc) => {
        const message = doc.data();
        const item = document.createElement('li');
        item.textContent = message.text;
        
        const infoSpan = document.createElement('span');
        infoSpan.classList.add('message-info');
        let senderInfo = message.user || 'Unknown';
        if (message.timestamp) {
            const date = message.timestamp.toDate(); // Convert Firestore Timestamp to JS Date
            senderInfo += ` at ${date.toLocaleTimeString()} - ${date.toLocaleDateString()}`;
        }
        infoSpan.textContent = senderInfo;

        item.prepend(infoSpan); // Add sender/time info above the message text

        if (message.user === userInput.value) { // Basic check to style "my" messages
            item.classList.add('mine');
        }

        messagesUl.appendChild(item);
      });
      // Scroll to the bottom of the chat
      messagesUl.scrollTop = messagesUl.scrollHeight;
      messagesUl.parentElement.scrollTop = messagesUl.parentElement.scrollHeight; // Scroll parent div
    });

    // Handle sending messages
    form.addEventListener('submit', async function(e) {
      e.preventDefault(); // Prevent page refresh
      const messageText = messageInput.value.trim();
      const userName = userInput.value.trim() || 'Anonymous'; // Use "Anonymous" if user name is empty

      if (messageText) {
        try {
          // Add a new message document to the 'messages' collection
          await addDoc(messagesCollection, {
            text: messageText,
            user: userName,
            timestamp: serverTimestamp() // Firebase server timestamp for accurate ordering
          });
          messageInput.value = ''; // Clear input field
        } catch (e) {
          console.error("Error adding document: ", e);
          alert("Error sending message. Check console for details.");
        }
      }
    });
  </script>
</body>
</html>

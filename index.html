<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øª Ø±ÙˆÙ… ØµÙˆØªÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; text-align: center; }
        .container { background-color: #fff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); max-width: 500px; width: 90%; }
        h1 { color: #1a73e8; margin-top: 0; }
        p { line-height: 1.6; }
        .buttons { margin: 20px 0; }
        button { background-color: #1a73e8; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 0 10px; transition: background-color 0.3s, transform 0.2s; }
        button:hover:not(:disabled) { background-color: #1558b8; transform: translateY(-2px); }
        button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
        #hangupBtn { background-color: #d93025; }
        #hangupBtn:hover:not(:disabled) { background-color: #b5281e; }
        #status { margin-top: 20px; font-weight: bold; color: #555; min-height: 24px; transition: color 0.3s; }
        #remote-audios video, #remote-audios audio { display: none; }
        .lobby { margin-top: 25px; text-align: right; }
        .lobby h3 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        #user-list { list-style-type: none; padding: 0; }
        #user-list li { background-color: #e8f0fe; color: #1a73e8; padding: 8px 12px; border-radius: 20px; margin-bottom: 8px; display: inline-block; font-weight: 500; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ú†Øª Ø±ÙˆÙ… ØµÙˆØªÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</h1>
        <p>Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ "ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª"ØŒ Ø¨Ù‡ Ø§ØªØ§Ù‚ Ø¹Ù…ÙˆÙ…ÛŒ Ù…ØªØµÙ„ Ø´ÙˆÛŒØ¯. Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø­Ø§Ø¶Ø± Ø¯Ø± Ø²ÛŒØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
        <div class="buttons">
            <button id="joinBtn">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª</button>
            <button id="hangupBtn" disabled>Ø®Ø±ÙˆØ¬</button>
        </div>
        <div id="status">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§ØªØµØ§Ù„...</div>
        <div class="lobby">
            <h3>Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø­Ø§Ø¶Ø± Ø¯Ø± Ù„Ø§Ø¨ÛŒ</h3>
            <ul id="user-list"></ul>
        </div>
        <div id="remote-audios"></div>
    </div>

    <script type="module">
        // 1. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAk3aehEN_aCT0VHE29sSIi72Htpb7vbAk",
            authDomain: "voic-acfa3.firebaseapp.com",
            projectId: "voic-acfa3",
            storageBucket: "voic-acfa3.firebasestorage.app",
            messagingSenderId: "7797643208",
            appId: "1:7797643208:web:ca69e49eb448a96cf8d2fd",
            measurementId: "G-1VQXZKZ6T9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // 2. Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ
        const joinBtn = document.getElementById('joinBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const statusDiv = document.getElementById('status');
        const remoteAudiosContainer = document.getElementById('remote-audios');
        const userList = document.getElementById('user-list');
        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };
        let localStream, localId, userDocRef;
        const peerConnections = {}; 
        let firestoreUnsubscribes = [];

        // 3. Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡
        const joinRoom = async () => {
            joinBtn.disabled = true; hangupBtn.disabled = false;
            statusDiv.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†...';
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                localId = Math.random().toString(36).substring(2, 12);
                userDocRef = await addDoc(collection(db, 'users'), { id: localId, name: `Ú©Ø§Ø±Ø¨Ø± ${localId}` });
                setupListeners();
                statusDiv.textContent = 'Ø´Ù…Ø§ Ø¯Ø± Ø§ØªØ§Ù‚ Ù‡Ø³ØªÛŒØ¯. Ù…Ù†ØªØ¸Ø± Ø¯ÛŒÚ¯Ø±Ø§Ù†...';
            } catch (error) {
                console.error("âŒ Ø®Ø·Ø§: ", error);
                statusDiv.textContent = 'Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.';
                hangup();
            }
        };

        function setupListeners() {
            const usersUnsubscribe = onSnapshot(collection(db, 'users'), (snapshot) => {
                userList.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const li = document.createElement('li');
                    li.textContent = user.name + (user.id === localId ? ' (Ø´Ù…Ø§)' : '');
                    userList.appendChild(li);
                });

                snapshot.docChanges().forEach(change => {
                    const user = change.doc.data();
                    if (change.type === 'added' && user.id !== localId) {
                        // **Ø§ØµÙ„Ø§Ø­ Ú©Ù„ÛŒØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„ Glare**
                        // ÙÙ‚Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ú©Ù‡ Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø²Ø±Ú¯ØªØ±ÛŒ Ø¯Ø§Ø±Ø¯ØŒ ØªÙ…Ø§Ø³ Ø±Ø§ Ø¢ØºØ§Ø² Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
                        const isInitiator = localId > user.id;
                        createPeerConnection(user.id, isInitiator);
                    }
                    if (change.type === 'removed' && peerConnections[user.id]) {
                        peerConnections[user.id].pc.close();
                        delete peerConnections[user.id];
                    }
                });
            });

            const signalsQuery = query(collection(db, 'signals'), where("to", "==", localId));
            const signalsUnsubscribe = onSnapshot(signalsQuery, async (snapshot) => {
                for (const change of snapshot.docChanges()) {
                    if (change.type === 'added') {
                        const signal = change.doc.data();
                        if (!peerConnections[signal.from]) createPeerConnection(signal.from, false);
                        const { pc, iceCandidateQueue } = peerConnections[signal.from];
                        try {
                            if (signal.sdp) {
                                await pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
                                while (iceCandidateQueue.length > 0) {
                                    await pc.addIceCandidate(iceCandidateQueue.shift());
                                }
                                if (pc.remoteDescription.type === 'offer') {
                                    const answer = await pc.createAnswer();
                                    await pc.setLocalDescription(answer);
                                    sendSignal(signal.from, { sdp: pc.localDescription.toJSON() });
                                }
                            } else if (signal.candidate) {
                                if (pc.remoteDescription) await pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
                                else iceCandidateQueue.push(new RTCIceCandidate(signal.candidate));
                            }
                        } catch (e) { console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³ÛŒÚ¯Ù†Ø§Ù„: ", e); }
                        await deleteDoc(change.doc.ref);
                    }
                }
            });
            firestoreUnsubscribes.push(usersUnsubscribe, signalsUnsubscribe);
        }

        function createPeerConnection(remoteId, isInitiator) {
            console.log(`ðŸ¤ Ø§ÛŒØ¬Ø§Ø¯ PeerConnection Ø¨Ø±Ø§ÛŒ ${remoteId}. Ø¢ÛŒØ§ Ù…Ø§ Ø¢ØºØ§Ø²Ú¯Ø± Ù‡Ø³ØªÛŒÙ…ØŸ ${isInitiator}`);
            const pc = new RTCPeerConnection(servers);
            peerConnections[remoteId] = { pc: pc, iceCandidateQueue: [] };
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            pc.ontrack = event => {
                const audioEl = document.createElement('audio');
                audioEl.srcObject = event.streams[0];
                audioEl.autoplay = true;
                remoteAudiosContainer.appendChild(audioEl);
            };
            pc.onicecandidate = e => e.candidate && sendSignal(remoteId, { candidate: e.candidate.toJSON() });
            pc.onconnectionstatechange = () => {
                if (pc.connectionState === 'connected') {
                    statusDiv.textContent = 'Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ Ù…Ú©Ø§Ù„Ù…Ù‡...';
                    statusDiv.style.color = 'green';
                }
            };
            if (isInitiator) {
                pc.createOffer().then(o => pc.setLocalDescription(o)).then(() => {
                    sendSignal(remoteId, { sdp: pc.localDescription.toJSON() });
                });
            }
        }

        async function sendSignal(toId, data) {
            await addDoc(collection(db, 'signals'), { to: toId, from: localId, ...data });
        }

        const hangup = async () => {
            firestoreUnsubscribes.forEach(unsub => unsub());
            firestoreUnsubscribes = [];
            Object.values(peerConnections).forEach(conn => conn.pc.close());
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            remoteAudiosContainer.innerHTML = ''; userList.innerHTML = '';
            if (userDocRef) await deleteDoc(userDocRef);
            localStream = null; userDocRef = null;
            joinBtn.disabled = false; hangupBtn.disabled = true;
            statusDiv.textContent = 'Ø´Ù…Ø§ Ø§Ø² Ø§ØªØ§Ù‚ Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.';
            statusDiv.style.color = '#555';
        };

        joinBtn.onclick = joinRoom; hangupBtn.onclick = hangup;
        window.addEventListener('beforeunload', () => localStream && hangup());
    </script>
</body>
</html>

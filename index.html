<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>چت روم صوتی عمومی</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; text-align: center; }
        .container { background-color: #fff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); max-width: 500px; width: 90%; }
        h1 { color: #1a73e8; margin-top: 0; }
        p { line-height: 1.6; }
        .buttons { margin: 20px 0; }
        button { background-color: #1a73e8; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 0 10px; transition: background-color 0.3s, transform 0.2s; }
        button:hover:not(:disabled) { background-color: #1558b8; transform: translateY(-2px); }
        button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
        #hangupBtn { background-color: #d93025; }
        #hangupBtn:hover:not(:disabled) { background-color: #b5281e; }
        #status { margin-top: 20px; font-weight: bold; color: #555; min-height: 24px; transition: color 0.3s; }
        #remote-audios video, #remote-audios audio { display: none; }
        .lobby { margin-top: 25px; text-align: right; }
        .lobby h3 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        #user-list { list-style-type: none; padding: 0; }
        #user-list li { background-color: #e8f0fe; color: #1a73e8; padding: 8px 12px; border-radius: 20px; margin-bottom: 8px; display: inline-block; font-weight: 500; }
    </style>
</head>
<body>

    <div class="container">
        <h1>چت روم صوتی عمومی</h1>
        <p>با کلیک روی "ورود به چت"، به اتاق عمومی متصل شوید. لیست کاربران حاضر در زیر نمایش داده می‌شود.</p>
        
        <div class="buttons">
            <button id="joinBtn">ورود به چت</button>
            <button id="hangupBtn" disabled>خروج</button>
        </div>

        <div id="status">در انتظار اتصال...</div>
        
        <div class="lobby">
            <h3>کاربران حاضر در لابی</h3>
            <ul id="user-list"></ul>
        </div>
        
        <div id="remote-audios"></div>
    </div>

    <script type="module">
        // 1. راه‌اندازی FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, where, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAk3aehEN_aCT0VHE29sSIi72Htpb7vbAk",
            authDomain: "voic-acfa3.firebaseapp.com",
            projectId: "voic-acfa3",
            storageBucket: "voic-acfa3.firebasestorage.app",
            messagingSenderId: "7797643208",
            appId: "1:7797643208:web:ca69e49eb448a96cf8d2fd",
            measurementId: "G-1VQXZKZ6T9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // 2. متغیرهای سراسری و تنظیمات WEBRTC
        const joinBtn = document.getElementById('joinBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const statusDiv = document.getElementById('status');
        const remoteAudiosContainer = document.getElementById('remote-audios');
        const userList = document.getElementById('user-list');

        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

        let localStream, localId, userDocRef;
        const peerConnections = {};
        let firestoreUnsubscribes = [];

        // 3. منطق اصلی برنامه
        const joinRoom = async () => {
            console.log("--- 🟢 دکمه ورود کلیک شد ---");
            joinBtn.disabled = true;
            hangupBtn.disabled = false;
            statusDiv.textContent = 'در حال درخواست دسترسی به میکروفون...';

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                console.log("✅ دسترسی به میکروفون موفقیت‌آمیز بود.");
                
                localId = Math.random().toString(36).substring(2, 10);
                userDocRef = await addDoc(collection(db, 'users'), { id: localId, name: `کاربر ${localId}` });
                console.log(`👤 کاربر به Firestore اضافه شد. شناسه شما: ${localId}`);

                setupListeners();
                statusDiv.textContent = 'شما در اتاق هستید. منتظر دیگران...';
            } catch (error) {
                console.error("❌ خطا در دسترسی به میکروفون: ", error);
                statusDiv.textContent = 'امکان دسترسی به میکروفون وجود ندارد. لطفا مجوز را بدهید.';
                hangup(); // بازگرداندن به حالت اولیه
            }
        };

        function setupListeners() {
            console.log("🎧 در حال تنظیم شنونده‌ها...");
            // شنونده برای کاربران
            const usersUnsubscribe = onSnapshot(collection(db, 'users'), (snapshot) => {
                userList.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const li = document.createElement('li');
                    li.textContent = user.name + (user.id === localId ? ' (شما)' : '');
                    userList.appendChild(li);
                });

                snapshot.docChanges().forEach(change => {
                    const user = change.doc.data();
                    if (change.type === 'added' && user.id !== localId) {
                        console.log(`[Users] کاربر جدید (${user.id}) وارد شد. شروع ارتباط...`);
                        createPeerConnection(user.id, true);
                    }
                    if (change.type === 'removed' && peerConnections[user.id]) {
                        console.log(`[Users] کاربر (${user.id}) خارج شد. قطع ارتباط...`);
                        peerConnections[user.id].close();
                        delete peerConnections[user.id];
                    }
                });
            });

            // شنونده برای سیگنال‌ها
            const signalsQuery = query(collection(db, 'signals'), where("to", "==", localId));
            const signalsUnsubscribe = onSnapshot(signalsQuery, (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added') {
                        const signal = change.doc.data();
                        const pc = peerConnections[signal.from];
                        
                        console.log(`[Signals] سیگنال از ${signal.from} دریافت شد.`, signal);

                        if (pc && signal.sdp) {
                            await pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
                            if (signal.sdp.type === 'offer') {
                                const answer = await pc.createAnswer();
                                await pc.setLocalDescription(answer);
                                sendSignal(signal.from, { sdp: pc.localDescription });
                            }
                        } else if (pc && signal.candidate) {
                            await pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
                        }
                        await deleteDoc(change.doc.ref);
                    }
                });
            });

            firestoreUnsubscribes.push(usersUnsubscribe, signalsUnsubscribe);
        }

        function createPeerConnection(remoteId, isInitiator) {
            if (peerConnections[remoteId]) {
                console.warn(`ارتباط با ${remoteId} از قبل وجود دارد.`);
                return;
            }
            console.log(`🤝 ایجاد PeerConnection برای ${remoteId}. آیا ما آغازگر هستیم؟ ${isInitiator}`);
            const pc = new RTCPeerConnection(servers);
            peerConnections[remoteId] = pc;

            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.ontrack = event => {
                console.log(`🎤 ترک صوتی از ${remoteId} دریافت شد.`);
                const audioEl = document.createElement('audio');
                audioEl.srcObject = event.streams[0];
                audioEl.autoplay = true;
                audioEl.playsInline = true;
                remoteAudiosContainer.appendChild(audioEl);
                audioEl.play().catch(e => console.error("❌ خطا در پخش خودکار صدا: ", e));
            };

            pc.onicecandidate = e => {
                if (e.candidate) {
                    sendSignal(remoteId, { candidate: e.candidate.toJSON() });
                }
            };
            
            pc.onconnectionstatechange = () => {
                console.log(`[State] وضعیت اتصال با ${remoteId}: ${pc.connectionState}`);
                if(pc.connectionState === 'connected') {
                    statusDiv.textContent = 'اتصال برقرار شد! در حال مکالمه...';
                    statusDiv.style.color = 'green';
                } else if (pc.connectionState === 'failed') {
                    statusDiv.textContent = `اتصال با ${remoteId} ناموفق بود.`;
                    statusDiv.style.color = 'red';
                    pc.restartIce(); // تلاش برای اتصال مجدد
                }
            };

            if (isInitiator) {
                pc.createOffer().then(o => pc.setLocalDescription(o)).then(() => {
                    console.log(`[Offer] Offer ساخته شد. در حال ارسال برای ${remoteId}...`);
                    sendSignal(remoteId, { sdp: pc.localDescription });
                });
            }
        }

        async function sendSignal(toId, data) {
            console.log(`📤 ارسال سیگنال به ${toId}:`, data);
            await addDoc(collection(db, 'signals'), { to: toId, from: localId, ...data });
        }

        const hangup = async () => {
            console.log("--- 🔴 دکمه خروج کلیک شد ---");
            firestoreUnsubscribes.forEach(unsub => unsub());
            firestoreUnsubscribes = [];

            Object.values(peerConnections).forEach(pc => pc.close());
            
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            localStream = null;

            remoteAudiosContainer.innerHTML = '';
            userList.innerHTML = '';

            if (userDocRef) {
                await deleteDoc(userDocRef);
                console.log("👤 کاربر از Firestore حذف شد.");
                userDocRef = null;
            }

            joinBtn.disabled = false;
            hangupBtn.disabled = true;
            statusDiv.textContent = 'شما از اتاق خارج شدید.';
            statusDiv.style.color = '#555';
        };

        joinBtn.onclick = joinRoom;
        hangupBtn.onclick = hangup;
        window.addEventListener('beforeunload', () => {
            if (localStream) hangup();
        });
    </script>
</body>
</html>
